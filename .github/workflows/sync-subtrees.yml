name: Sync Subtrees from JSON (With PAT) & Clean Old Actions Runs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨ 3 ç‚¹è¿è¡Œ
  workflow_run:
    workflows: ["Sync Subtrees from JSON (With PAT)"]
    types:
      - completed

env:
  PROJECT_CONFIG_URL: https://raw.githubusercontent.com/hanlihanshaobo/openwrt-packages/main/projects.json
jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}  # ä½¿ç”¨ä½ çš„ Personal Access Token

      - name: Setup Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Download project config JSON
        run: curl -sSL "$PROJECT_CONFIG_URL" -o projects.json

      - name: Parse and Sync Projects
        run: |
          changes=0
          jq -c '.[]' projects.json | while read -r project; do
            name=$(echo "$project" | jq -r '.name')
            repo=$(echo "$project" | jq -r '.repo')
            branch=$(echo "$project" | jq -r '.branch // "master"')
            enabled=$(echo "$project" | jq -r '.enabled')

            echo "ğŸ“¦ é¡¹ç›®: $name | åˆ†æ”¯: $branch | å¯ç”¨: $enabled"

            if [[ "$enabled" == "true" ]]; then
              if [ -d "$name" ]; then
                echo "ğŸ”„ æ›´æ–° $name"
                git subtree pull --prefix="$name" "$repo" "$branch" --squash || echo "âš ï¸ æ— å˜æ›´æˆ–æ‹‰å–å¤±è´¥"
              else
                echo "â• æ·»åŠ  $name"
                git subtree add --prefix="$name" "$repo" "$branch" --squash || echo "âŒ æ·»åŠ å¤±è´¥ï¼Œå¯èƒ½åˆ†æ”¯ä¸å­˜åœ¨"
              fi
              changes=1
            else
              if [ -d "$name" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æœªå¯ç”¨çš„ç›®å½• $name"
                git rm -rf "$name" || echo "âš ï¸ åˆ é™¤å¤±è´¥"
                git commit -m "Remove $name (disabled in config)"
                changes=1
              fi
            fi
          done

      - name: Show working directory contents
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„ï¼š"
          tree -L 2 || ls -R

      - name: Show git status & diff
        run: |
          echo "ğŸ“Œ Git çŠ¶æ€ï¼š"
          git status
          echo "ğŸ“Œ Git Diffï¼š"
          git diff --stat || true

      - name: Commit changes if needed
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ’¾ æäº¤æ›´æ”¹"
            git add .
            git commit -m "Sync subtrees from config"
          else
            echo "âœ… æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: Push changes using PAT
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}
          if [ -n "$(git log origin/main..HEAD)" ]; then
            echo "ğŸš€ æ¨é€åˆ° main åˆ†æ”¯"
            git push origin main
          else
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æ¨é€çš„å˜æ›´"
          fi

  cleanup:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Set up GitHub token
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ç”¨äºè°ƒç”¨ GitHub API
        run: |
          echo "GitHub Token setup completed"

      - name: Get workflow runs
        run: |
          # è·å–æ‰€æœ‰å·¥ä½œæµè¿è¡Œè®°å½•
          runs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100")

          # è·å–æ‰€æœ‰è¿è¡Œè®°å½•çš„ ID å’Œæ—¶é—´
          run_ids=$(echo "$runs" | jq -r '.workflow_runs | sort_by(.created_at) | .[0:93] | .[].id')

          # åˆ é™¤è¶…è¿‡ 7 æ¬¡çš„è®°å½•
          echo "å°†åˆ é™¤çš„æ—§è®°å½• ID:"
          echo "$run_ids"
          
          # åªä¿ç•™æœ€æ–°çš„ 7 æ¬¡è®°å½•
          to_delete=$(echo "$run_ids" | tail -n +8)

          for run_id in $to_delete; do
            # åˆ é™¤æ—§çš„è¿è¡Œè®°å½•
            echo "åˆ é™¤æ—§è®°å½• ID: $run_id"
            curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id"
