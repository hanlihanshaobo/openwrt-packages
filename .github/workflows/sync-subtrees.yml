name: Sync Subtrees from JSON

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  PROJECT_CONFIG_URL: https://raw.githubusercontent.com/hanlihanshaobo/openwrt-packages/refs/heads/main/packages.json

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Download project config JSON
        run: curl -sSL "$PROJECT_CONFIG_URL" -o projects.json

      - name: Parse and Sync Projects
        run: |
          changes=0
          jq -c '.[]' projects.json | while read -r project; do
            name=$(echo "$project" | jq -r '.name')
            repo=$(echo "$project" | jq -r '.repo')
            branch=$(echo "$project" | jq -r '.branch // "master"')
            enabled=$(echo "$project" | jq -r '.enabled')

            echo "📦 项目: $name | 分支: $branch | 启用: $enabled"

            if [[ "$enabled" == "true" ]]; then
              if [ -d "$name" ]; then
                echo "🔄 更新 $name"
                git subtree pull --prefix="$name" "$repo" "$branch" --squash || echo "No changes"
              else
                echo "➕ 添加 $name"
                git subtree add --prefix="$name" "$repo" "$branch" --squash
              fi
              changes=1
            else
              if [ -d "$name" ]; then
                echo "❌ 删除 $name"
                git rm -rf "$name"
                git commit -m "Remove $name (disabled in config)"
                changes=1
              fi
            fi
          done

          if [[ "$changes" == "0" ]]; then
            echo "✅ 没有需要同步的更改"
          fi

      - name: Push if changed
        run: |
          git diff --quiet || git push origin main
