name: Sync Subtrees (auto delete undefined projects)

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  ENABLE_OPENWRT_THIRD: true
  ENABLE_ISTOREOS: false
  # 注意：未定义的项目变量如 ENABLE_PROJECT_X 将被视为 false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Define and sync known projects
        run: |
          declare -A repos=(
            ["openwrt-third"]="https://github.com/jjm2473/openwrt-third.git"
            ["istoreos"]="https://github.com/istoreos/istoreos.git"
          )

          for project in "${!repos[@]}"; do
            # 生成变量名（如 ENABLE_OPENWRT_THIRD）
            VAR_NAME="ENABLE_${project^^//-/_}" # 将小写转大写并替换横线为下划线
            ENABLED="${!VAR_NAME}"

            if [[ "$ENABLED" == "true" ]]; then
              echo "✅ $project is enabled"

              if [ -d "$project" ]; then
                git subtree pull --prefix="$project" "${repos[$project]}" master --squash || echo "No changes"
              else
                git subtree add --prefix="$project" "${repos[$project]}" master --squash
              fi
            else
              echo "❌ $project is not enabled"
              if [ -d "$project" ]; then
                git rm -rf "$project"
                git commit -m "Remove $project (disabled or unset)"
              fi
            fi
          done

      - name: Push changes
        run: |
          git push origin main
