name: Sync Subtrees

on:
  workflow_dispatch:
  schedule:
    - cron: '20 9 * * *'

env:
  PROJECT_CONFIG_URL: https://raw.githubusercontent.com/hanlihanshaobo/openwrt-packages/main/projects.json

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Download project config JSON
        run: curl -sSL "$PROJECT_CONFIG_URL" -o projects.json

      - name: Parse and Sync Projects
        run: |
          jq -c '.[]' projects.json | while read -r project; do
            name=$(echo "$project" | jq -r '.name')
            repo=$(echo "$project" | jq -r '.repo')
            branch=$(echo "$project" | jq -r '.branch // "master"')
            enabled=$(echo "$project" | jq -r '.enabled')

            echo "ğŸ“¦ é¡¹ç›®: $name | åˆ†æ”¯: $branch | å¯ç”¨: $enabled"

            if [[ "$enabled" == "true" ]]; then
              if [ -d "$name" ]; then
                echo "ğŸ”„ æ›´æ–° $name"
                git subtree pull --prefix="$name" "$repo" "$branch" --squash || echo "âš ï¸ æ— å˜æ›´æˆ–æ‹‰å–å¤±è´¥"
              else
                echo "â• æ·»åŠ  $name"
                git subtree add --prefix="$name" "$repo" "$branch" --squash || echo "âŒ æ·»åŠ å¤±è´¥ï¼Œå¯èƒ½åˆ†æ”¯ä¸å­˜åœ¨"
              fi
            else
              if [ -d "$name" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æœªå¯ç”¨çš„ç›®å½• $name"
                git rm -rf "$name" || echo "âš ï¸ åˆ é™¤å¤±è´¥"
                git commit -m "Remove $name (disabled in config)"
              fi
            fi
          done

      - name: Show directory tree (2 levels)
        run: tree -L 2 || ls -R

      - name: Show git status & diff
        run: |
          git status
          git diff --stat || true

      - name: Commit project sync if changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ”„ Sync subtrees from config"
          else
            echo "âœ… æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: Push changes to main branch
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}
          if [ -n "$(git log origin/main..HEAD)" ]; then
            git push origin main
          else
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æ¨é€çš„å˜æ›´"
          fi

      - name: Generate pretty README from synced projects
        run: |
          echo "# ğŸ“¦ Synced Projects" > README.md
          echo "" >> README.md
          echo "é€šè¿‡ \`projects.json\` è‡ªåŠ¨åŒæ­¥çš„å­é¡¹ç›®å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š" >> README.md
          echo "" >> README.md
          echo "| é¡¹ç›®åç§° | åˆ†æ”¯ | ä»“åº“åœ°å€ | å¯ç”¨çŠ¶æ€ |" >> README.md
          echo "|----------|------|-----------|----------|" >> README.md

          jq -c '.[]' projects.json | sort | while read -r project; do
            name=$(echo "$project" | jq -r '.name')
            repo=$(echo "$project" | jq -r '.repo')
            branch=$(echo "$project" | jq -r '.branch // "master"')
            enabled=$(echo "$project" | jq -r '.enabled')
            status="âŒ"
            [[ "$enabled" == "true" ]] && status="âœ…"
            echo "| **$name** | \`$branch\` | [GitHub]($repo) | $status |" >> README.md
          done

          echo "" >> README.md
          echo "> â±ï¸ æ›´æ–°æ—¶é—´ï¼š$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')ï¼ˆç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼‰" >> README.md

      - name: Commit README if changed
        run: |
          if [ -n "$(git status --porcelain README.md)" ]; then
            git add README.md
            git commit -m "ğŸ“˜ æ›´æ–°è‡ªåŠ¨ç”Ÿæˆçš„ README.md"
            echo "ğŸ“¥ æ‹‰å–è¿œç¨‹æ›´æ–°ä»¥é¿å…å†²çª"
            git pull --rebase origin main || echo "âš ï¸ æ‹‰å–å†²çªæˆ–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
            echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°è¿œç¨‹"
            git push origin main
          else
            echo "ğŸ†— README æ— éœ€æ›´æ–°"
          fi

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 7
          keep_minimum_runs: 7
