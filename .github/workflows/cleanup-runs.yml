name: Clean Old Actions Runs

on:
  schedule:
    - cron: '0 4 * * *'  # æ¯å¤©å‡Œæ™¨ 4 ç‚¹è¿è¡Œ
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate GH CLI with PAT
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo $GH_TOKEN | gh auth login --with-token

      - name: Delete old workflow runs (keep last 7)
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "ğŸ§¼ æ¸…ç†æ—§çš„ GitHub Actions è¿è¡Œè®°å½•ï¼ˆä¿ç•™ 7 ä¸ªï¼‰"
          runs=$(gh api -X GET /repos/${{ github.repository }}/actions/runs --paginate -q '.workflow_runs | sort_by(.created_at) | .[].id')
          count=0
          for run_id in $runs; do
            count=$((count + 1))
            if [ $count -le 7 ]; then
              continue
            fi
            echo "ğŸ—‘ï¸ åˆ é™¤è¿è¡Œè®°å½• ID: $run_id"
            gh api --method DELETE /repos/${{ github.repository }}/actions/runs/$run_id || echo "âš ï¸ æ— æ³•åˆ é™¤ $run_id"
          done
